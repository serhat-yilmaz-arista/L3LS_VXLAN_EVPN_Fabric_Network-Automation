{# Global Configs #}
!
no aaa root
!
username admin privilege 15 role network-admin secret sha512 $6$3.NRDQ/MSPm2WWfg$8WYiC5OdPD6ph60.2C0KG6MEtdZoa1tqzcr4AMC.yPGqPAMf3.KDRAb0ez3tbor8TuAEjY7vrzoSSmb/o6wEe.
!
management api http-commands
   no shutdown
!
daemon TerminAttr
   exec /usr/bin/TerminAttr -smashexcludes=ale,flexCounter,hardware,kni,pulse,strata -cvaddr=10.243.248.63:9910 -cvauth=token,/tmp/token -cvvrf=default -taillogs
   no shutdown
!
no service interface inactive port-id allocation disabled
!
transceiver qsfp default-mode 4x10G
!
service routing protocols model multi-agent
!
hostname {{ inventory_hostname }}
!
spanning-tree mode mstp
!
system l1
   unsupported speed action error
   unsupported error-correction action error
!
management api gnmi
   transport grpc default
!
management api netconf
   transport ssh default
!
interface Management0
   ip address {{ hostvars[inventory_hostname].ansible_host }}/24
   ipv6 address {{ hosts_map[inventory_hostname].ipv6 }}
!
ip routing
!
ip route 0.0.0.0/0 172.20.20.1
!
ipv6 route ::/0 3fff:172:20:20::1
!
router multicast
   ipv4
      software-forwarding kernel
   !
   ipv6
      software-forwarding kernel
!
!
!
{# Expecting data under hosts_map[inventory_hostname] #}
{% set h = hosts_map[inventory_hostname] %}
!
{% for vlan in h.vlans %}
vlan {{ vlan.id }}
{% endfor %}
!
{% for pc in h.port_channels %}
interface Port-Channel{{ pc.id }}
   description From_{{ inventory_hostname }}_to_{{ h.port_channels[0].connected_leaf | join('&') }}
   switchport
   switchport mode trunk
{%     for vlan in h.vlans %}
   switchport trunk allowed vlan {{ vlan.id }}
{%     endfor %}
   no shutdown
!
{%     for ifname in pc.interfaces %}
interface {{ ifname }}
   channel-group {{ pc.id }} mode active
   no shutdown
{%     endfor %}
{% endfor %}
!
{% for vlan in h.vlans %}
interface Vlan{{ vlan.id }}
   no autostate
   ip address {{ vlan.svi_ip }}
{% endfor %}
!
ip routing
!
{% for vlan in h.vlans %}
{%     for pfx in h.static_routes %}
ip route {{ pfx }} {{ vlan.gateway }}
{%     endfor %}
{% endfor %}
!
end
